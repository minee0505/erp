# [TIL] 2026-02-09

## ERP 견적 관리 화면 저장 및 삭제 로직 트러블슈팅

## 1. 마스터 테이블 저장 시 데이터 무결성 에러 해결

### 문제 상황

* 견적 정보를 저장하려고 할 때 `EstimateNo(견적번호)` 컬럼에 NULL 값을 삽입할 수 없다는 에러가 발생하며 저장이 실패함.


* SQL Profiler 확인 결과, 실제 테이블에 데이터가 들어가기 직전에 번호가 비어있는 상태였음.

### 원인 분석

* 
**외부키 설정 누락:** Ksystem의 '업무별 외부키 생성 정의 등록' 화면에서 해당 테이블명과 채번 규칙이 정확히 등록되지 않았음.


* 
**자동 채번 메커니즘 오해:** DB의 `Identity` 기능이 아니라, `_SCOMCreateNo`라는 공통 프로시저를 통해 번호를 생성해서 템프 테이블에 업데이트해주는 방식인데 이 과정에서 값이 생성되지 않음.



### 해결 및 배운 점

* 시스템 설정 화면에서 테이블명을 올바르게 수정하여 채번 로직이 정상 작동하도록 조치함.
* 
**배운 점:** ERP 시스템에서는 DB의 자동 증가 기능보다 별도의 채번 로직을 타는 경우가 많으므로, 관련 공통 설정과 프로시저의 실행 순서를 반드시 먼저 확인해야 함.



---

## 2. 마스터와 디테일 테이블 간의 데이터 불일치 및 삭제 실패

### 문제 상황

* 저장은 성공했으나, DB 조회 결과 디테일 테이블의 `EstimateSeq(견적내부코드)`가 모두 `0`으로 박혀 데이터가 꼬임.
* 이로 인해 삭제 버튼을 눌러도 마스터와 디테일의 번호가 매칭되지 않아 SQL Profiler에 삭제 쿼리가 아예 찍히지 않음.

### 원인 분석

* **메서드 실행 순서의 오류:** `마스터체크` 직후에 번호를 복사하는 `C(복사)` 단계가 위치해 있어, 실제 번호가 확정되기 전의 값(`0`)이 디테일로 전달됨.
* **삭제 제약 조건:** 자식(디테일) 데이터가 남아있는 상태에서 부모(마스터)를 먼저 삭제하려다 보니 DB 제약 조건에 걸려 쿼리가 실행되지 못함.

### 해결 및 배운 점

* **복사 위치 조정:** 마스터 번호가 생성된 직후에 디테일 템프 테이블로 번호를 복사하도록 데이터 흐름을 수정해야 함.
* **삭제 순서의 원칙:** 자식(`ItemSave`) -> 부모(`Save`) 순으로 작업리스트를 배치해야 정상적으로 데이터가 지워진다는 것을 배움.

---

## 3. 오늘의 회고 (Action Plan)

* **내일의 목표:** 오늘 배운 내용을 바탕으로 별도의 '삭제 이벤트'를 생성하고, 작업리스트의 순서를 **디테일 삭제 후 마스터 삭제**가 되도록 세팅할 것.
* **다짐:** "이름순"이 아니라 "등록된 순서"와 "데이터 흐름(G-M-S)"이 핵심이라는 것을 잊지 말고, 로그 화면에서 각 단계의 데이터를 꼼꼼히 체크하는 습관을 들이자.
